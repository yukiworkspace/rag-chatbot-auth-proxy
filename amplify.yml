version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Building IP Authentication Proxy for RAG ChatBot"
        - pwd
        - ls -la
        - echo "Environment variables check"
        - "echo STREAMLIT_URL: ${STREAMLIT_URL}"
        - "echo ALLOWED_IPS: ${ALLOWED_IPS}"
        - "echo REDIRECT_DELAY: ${REDIRECT_DELAY}"
    build:
      commands:
        - echo "Preparing static files with environment variable substitution"
        - |
          if [ -f "index.html" ]; then
            echo "index.html found"
          else
            echo "index.html not found"
            exit 1
          fi
        - echo "Substituting environment variables in index.html"
        - |
          if [ -z "$STREAMLIT_URL" ]; then
            echo "Error: STREAMLIT_URL environment variable is not set"
            exit 1
          fi
          if [ -z "$ALLOWED_IPS" ]; then
            echo "Error: ALLOWED_IPS environment variable is not set"
            exit 1
          fi
          
          REDIRECT_DELAY=${REDIRECT_DELAY:-3}
          
          sed -i "s|%%STREAMLIT_URL%%|${STREAMLIT_URL}|g" index.html
          sed -i "s|%%ALLOWED_IPS%%|${ALLOWED_IPS}|g" index.html
          sed -i "s|%%REDIRECT_DELAY%%|${REDIRECT_DELAY}|g" index.html
          
          echo "Environment variables substituted successfully"
          
          grep -n "STREAMLIT_URL\|ALLOWED_IPS\|REDIRECT_DELAY" index.html || echo "All placeholders have been replaced"
    postBuild:
      commands:
        - echo "Build completed successfully"
        - echo "IP Authentication Proxy ready for deployment"
        - "echo Configuration summary"
        - "echo Streamlit URL: ${STREAMLIT_URL}"
        - "echo Allowed IPs: ${ALLOWED_IPS}"
        - "echo Redirect delay: ${REDIRECT_DELAY} seconds"
  artifacts:
    baseDirectory: .
    files:
      - index.html
      - "**/*"
  cache:
    paths: []
